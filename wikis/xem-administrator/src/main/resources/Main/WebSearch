<?xml version="1.0" encoding="ISO-8859-1"?>

<xwikidoc>
<web>Main</web>
<name>WebSearch</name>
<language></language>
<defaultLanguage>en</defaultLanguage>
<translation>0</translation>
<parent></parent>
<creator>XWiki.Admin</creator>
<author>XWiki.Admin</author>
<customClass></customClass>
<contentAuthor>XWiki.Admin</contentAuthor>
<creationDate>1107744420000</creationDate>
<date>1180460662000</date>
<contentUpdateDate>1180460660000</contentUpdateDate>
<version>1.29</version>
<title></title>
<template></template>
<defaultTemplate></defaultTemplate>
<validationScript></validationScript>
<comment></comment>
<object>
<class>
<name>XWiki.TagClass</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<tags>
<name>tags</name>
<prettyName>Tags</prettyName>
<unmodifiable>0</unmodifiable>
<relationalStorage>1</relationalStorage>
<displayType>input</displayType>
<multiSelect>1</multiSelect>
<size>30</size>
<separator> </separator>
<cache>0</cache>
<separators> ,|</separators>
<values></values>
<number>1</number>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</tags>
</class>
<name>Main.WebSearch</name>
<number>0</number>
<className>XWiki.TagClass</className>
<property>
<tags/>
</property>
</object>
<content>1 Search

#if(!$request.space)
  #set($space = "All")
#else
  #set($space = $request.space)
#end

#set($spacesText = {})
#set($spaces = $xwiki.spaces)
#set($ok = $spacesText.put("All","All"))
#foreach($space in $spaces)
  #set($ok = $spacesText.put($space,$space))
#end

#macro(spaceoption $space $selectspace $spacesText)
  &lt;option value="$spacesText.get($space)" #if($selectspace == $spacesText.get($space))selected#end&gt;$space&lt;/option&gt;
#end

#macro(spaceselect $selectspace $spaces $spacesText)
  &lt;select name="space"&gt;
    #spaceoption("All" $selectspace $spacesText)
    #foreach($space in $spaces)
      #spaceoption($space $selectspace $spacesText)
    #end
  &lt;/select&gt;
#end

#if($request.getParameter("text"))
  #set($text = $request.getParameter("text"))
#else
  #set($text = "")
#end

#set($utext = $xwiki.getURLEncoded($text))
#if($space == "All")
  #set($url = $xwiki.getURL("Main.WebSearchRss", "view", "xpage=rdf&amp;text=${utext}" ))
#else
  #set($url = $xwiki.getURL("Main.WebSearchRss", "view", "xpage=rdf&amp;space=$space&amp;text=${utext}"))
#end

&lt;div style="float: right;"&gt;
  &lt;a href="$url"&gt;&lt;img src="$xwiki.getSkinFile("icons/black-rss.png")" border="0px" /&gt;&lt;/a&gt;
&lt;/div&gt;

&lt;form action=""&gt;
  {pre}
    &lt;div class="centered"&gt;
      Query
      &lt;input type="text" name="text" value="$!text.replace("&gt;", "&amp;gt;").replace("&lt;", "&amp;lt;").replace('"', "&amp;quot;")" size="20"/&gt;
      in space #spaceselect($space $spaces $spacesText) &lt;input type="submit" value="Search"/&gt;
    &lt;/div&gt;
  {/pre}
&lt;/form&gt;

#if($text == "")
  ## No search
#else
  #set($text = $text.replaceAll("'", "''").replaceAll("%", "\\%"))
  #set($datedlist = $xwiki.arrayList)
  
  #set($nbitems = 50)
  
  ## -----------------------------------------------------------
  ## Non-admins should not see results from XWiki, Main, Admin 
  ## and Panels spaces. Also exclude the WebPreferences doc.
  ## -----------------------------------------------------------
  #if ($xwiki.hasAdminRights())
    #set ($excludedWebs = "")
  #else
    #set ($excludedWebs = "doc.web&lt;&gt;'XWiki' and doc.web&lt;&gt;'Admin' and doc.web&lt;&gt;'Panels' and doc.name&lt;&gt;'WebPreferences' and")
  #end

  ## -----------------------------------------------------------
  ## Display only a given space if $request.space is defined
  ## -----------------------------------------------------------
  #if($space == "All")
    #set ($webClause = "$excludedWebs")
  #else
    #set ($webClause = "doc.web='$space' and $excludedWebs")
  #end

  #macro(addelement $item $list)
    #if($xwiki.hasAccessLevel("view", $context.user, "${context.database}:${item}"))
      #set($itemdoc = $xwiki.getDocument($item))
      #set($sdate = $xwiki.formatDate($itemdoc.date, "yyyyMMddHHmmss"))
      #set($sitem = "${sdate}${item}")
      #if(!$list.contains($sitem))
        #set($discard = $list.add($sitem))
      #end
    #end
  #end

  ## -----------------------------------------------------------
  ## Search in page content
  ## -----------------------------------------------------------
  #set ($sql = "where $webClause upper(doc.content) like upper('%$!text%') order by doc.date desc")
  #foreach ($item in $xwiki.searchDocuments($sql , $nbitems, 0))
    #addelement($item $datedlist)
  #end

  ## -----------------------------------------------------------
  ## Search in text fields (simple String properties)
  ## -----------------------------------------------------------
  #set($sql= ", BaseObject as obj, StringProperty as prop where $webClause obj.name=doc.fullName and prop.id.id = obj.id and upper(prop.value) like upper('%$!text%')")
  #foreach ($item in $xwiki.searchDocuments($sql , $nbitems, 0))
    #addelement($item $datedlist)
  #end

  ## -----------------------------------------------------------
  ## Search in big text fields (textarea properties)
  ## -----------------------------------------------------------
  #set($sql= ", BaseObject as obj, LargeStringProperty as prop where $webClause obj.name=doc.fullName and prop.id.id = obj.id and upper(prop.value) like upper('%$!text%')")
  #foreach ($item in $xwiki.searchDocuments($sql , 50, 0))
    #addelement($item $datedlist)
  #end

  #set($list = $xwiki.arrayList)
  #foreach($item in $xwiki.sort($datedlist))
    #set($ok = $list.add(0, $item.substring(14)))
  #end
  
  #includeInContext("XWiki.Results")
  
#end
</content></xwikidoc>